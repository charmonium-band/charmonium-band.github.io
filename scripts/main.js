"use strict";function initAudioAnalyser(){function e(){var a=new Uint8Array(window.analyser.frequencyBinCount);window.analyser.getByteFrequencyData(a);for(var t=0,n=0;n<a.length;n++){var o=parseFloat(a[n]);t+=o*o}t=Math.sqrt(t/a.length),t/=100,window.currentVolume=Math.max(t,window.currentVolume*window.averaging),requestAnimationFrame(e)}if(window.currentVolume=0,window.context=new AudioContext||new webkitAudioContext,!window.context)return void console.log("No support for WebAudio");var a=context.createMediaElementSource(document.getElementById("player")),t=context.createAnalyser();t.smoothingTimeConstant=.9,t.fftSize=512,a.connect(t),t.connect(context.destination),window.currentVolume=0,window.averaging=.97,window.analyser=t,e()}function initVisualization(){function e(e){for(var a=[],t=1;t<=e.LAYERS.max;t+=1)a.push({rotX:t*e.ROTATION.value*(t%2===0?1:-1),rotY:t*e.ROTATION.value*(t%2===0?1:-1),rotZ:t*e.ROTATION.value*(t%2===0?1:-1),n:e.N.value,radius:e.RADIUS.value/Math.pow(t,e.RADIUS_POWER.value),radiusVariability:e.RADIUS_VARIABILITY.value/t,radiusVariabilityPower:e.RADIUS_VARIABILITY_POWER.value});return a}function a(){O=e(f),t()}function t(){v&&v.remove(d),d=s(),v.add(d)}function n(){y?(E.animate({opacity:0},150),setTimeout(function(){E.css({display:"none"})},150)):E.css({opacity:0,display:"block"}).animate({opacity:1},150)}function o(){h=!h;var e=$("#canvas").height(),a=$(window).height();h?($(".show-on-mouse-over-scene").animate({opacity:0},1e3),$(".hide-on-fullscreen").animate({opacity:0},250),P=$("#scene").css("margin-top"),$("#scene").animate({"margin-top":(a-e)/2})):($(".hide-on-fullscreen").animate({opacity:1},250),$("#scene").animate({"margin-top":P}))}function i(){E=$("#controls"),E.click(function(e){e.stopPropagation()}),$("#scene").mouseover(function(e){h||$(".show-on-mouse-over-scene").animate({opacity:.3},2e3)}),$("#scene").mouseleave(function(e){h||$(".show-on-mouse-over-scene").animate({opacity:0},250)}),$("#scene").click(function(e){e.altKey?n():o()}),_.keys(f).map(function(e){var t=f[e];console.log(e,t);var n=$("<label>"),o=$("<input>").attr(t).attr("type","range").on("change",function(t){var n=parseFloat(t.target.value);console.log(e+" = "+n),f[e].value=n,a()});n.append($("<div>").text(e)),n.append(o),E.append(n)})}function r(){l=$("#scene").width(),m=$("#scene").height(),I=new THREE.WebGLRenderer({alpha:!0,canvas:document.getElementById("canvas"),antialias:!1}),I.setSize(l,m),I.setPixelRatio(window.devicePixelRatio?window.devicePixelRatio:1),v=new THREE.Scene,p=new THREE.PerspectiveCamera(50,l/m,20,1e4),p.position.set(0,0,600),v.add(p),a(),requestAnimationFrame(c),window.addEventListener("resize",u)}function u(){l=$("#scene").width(),m=$("#scene").height(),p.aspect=l/m,p.updateProjectionMatrix(),I.setSize(l,m)}function s(){function e(e){var a=e.material,t=e.radius,n=e.rotX,o=e.rotY,i=e.rotZ,r=new THREE.EllipseCurve(0,0,t,t,0,2*Math.PI,(!1),0),u=new THREE.Path(r.getPoints(20)),s=u.createPointsGeometry(20);_.forEach(s.vertices,function(e){e.xOriginal=e.x,e.yOriginal=e.y,e.zOriginal=e.z});var c=new THREE.Line(s,a);return c.rotation.x=n,c.rotation.y=o,c.rotation.z=i,c}function a(a){for(var t=a.material,n=(a.n,a.radius),o=a.radiusVariability,i=a.radiusVariabilityPower,r=new THREE.Object3D,u=0;u<f.N.value;++u){var s=2*(Math.random()-.5)*Math.PI,c=2*(Math.random()-.5)*Math.PI,l=2*(Math.random()-.5)*Math.PI,m=n+Math.pow(n*o*Math.random(),i)*(Math.random()>.5?1:-1);r.add(e({material:t,radius:m,rotX:s,rotY:c,rotZ:l}))}return r}A=new THREE.MeshBasicMaterial({color:"white",fog:!0,opacity:f.OPACITY.value,transparent:!0,depthWrite:!1}),A.baseOpacity=f.OPACITY.value;var t=f.OPACITY.value*(1+f.OPACITY_PULSE_DEPTH.value+Math.random()*f.OPACITY_VARIABILITY.value);T=TweenMax.to(A,f.OPACITY_PULSE_PERIOD.value,{baseOpacity:t,repeat:-1,yoyo:!0,ease:Power2.easeIn}),d=new THREE.Object3D,w=[];for(var n=0;n<f.LAYERS.value;++n){var o=O[n],i=a(Object.assign({material:A},o)),r=f.PULSE_PERIOD.value*(1+Math.random()*f.PULSE_VARIABILITY.value),u=f.PULSE_DEPTH.value*(1+Math.random()*f.PULSE_VARIABILITY.value);i.scaleFactor=0,w.push(TweenMax.to(i,r,{scaleFactor:u,repeat:-1,yoyo:!0,ease:Power3.easeIn})),d.add(i)}return d}function c(){requestAnimationFrame(c);var e=window.currentVolume||0,a=.01;e<a&&!R?(R=!0,T&&(console.log("restart"),T.play()),w&&_.forEach(w,function(e){return e.play()})):e>a&&R&&(console.log("pause"),R=!1,T&&T.pause(),w&&_.forEach(w,function(e){return e.pause()})),_.forEach(d.children,function(a,t){var n=O[t];a.rotation.x+=n.rotX,a.rotation.y+=n.rotY,a.rotation.z+=n.rotZ,a.scale.set(1*(1+a.scaleFactor+f.AUDIO_SENSITIVITY.value*e),1*(1+a.scaleFactor+f.AUDIO_SENSITIVITY.value*e),1*(1+a.scaleFactor+f.AUDIO_SENSITIVITY.value*e)),A.opacity=A.baseOpacity*(.8+8*f.AUDIO_SENSITIVITY.value*e)}),I.render(v,p)}var l,m,I,v,p,d,A,E,T,w,P,R=!0,h=!1,y=!1,f={AUDIO_SENSITIVITY:{min:0,max:1,step:.001,value:.1},AUDIO_AVERAGING:{min:0,max:1,step:1e-4,value:.97},LAYERS:{min:1,max:10,step:1,value:3},N:{min:10,max:1500,step:10,value:230},RADIUS:{min:10,max:500,step:10,value:210},RADIUS_POWER:{min:.1,max:3,step:.01,value:.49},RADIUS_VARIABILITY:{min:0,max:2,step:.005,value:.08},RADIUS_VARIABILITY_POWER:{min:.2,max:4,step:.005,value:.805},OPACITY:{min:.01,max:.5,step:.001,value:.184},OPACITY_VARIABILITY:{min:0,max:2,step:.01,value:.2},OPACITY_PULSE_PERIOD:{min:.1,max:10,step:.01,value:.91},OPACITY_PULSE_DEPTH:{min:0,max:1,step:.01,value:.43},PULSE_DEPTH:{min:0,max:1,step:.001,value:.015},PULSE_PERIOD:{min:0,max:20,step:.01,value:.96},PULSE_VARIABILITY:{min:0,max:2,step:.01,value:0},ROTATION:{min:0,max:.005,step:5e-5,value:.0015},JITTER_PROBABILITY:{min:0,max:1,step:.01,value:0},JITTER_INTENSITY:{min:0,max:1,step:.01,value:0}},O=e(f);r(),i()}