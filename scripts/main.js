"use strict";function selectTrack(e){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],t=e.id,n=e.name,i=e.src;currentTrack=e;var r=$("#player source");r.attr("src",i),$("#current-track-name").text(n),$(".track").removeClass("current"),$("#music-content ol").removeClass("current"),$("#track-"+t).addClass("current"),$("#track-"+t).parent().addClass("current"),$("#player").get(0).load(),a&&$("#player").get(0).play()}function buildTracklists(e){e.map(function(e){var a=$("<ol/>");e.tracks.map(function(e){var t=$("<li/>",{class:"track",id:"track-"+e.id,click:function(){selectTrack(e,!0)}});t.text(e.name),a.append(t)});var t=$("<div>",{class:"tracklist"});t.append($("<h2>").text(e.name)),t.append(t),t.append(a),t.appendTo("#music-content")})}function initAudioAnalyser(){function e(){var a=new Uint8Array(window.analyser.frequencyBinCount);window.analyser.getByteFrequencyData(a);for(var t=0,n=0;n<a.length;n++){var i=parseFloat(a[n]);t+=i*i}t=Math.sqrt(t/a.length),t/=100,window.currentVolume=Math.max(t,window.currentVolume*window.averaging),requestAnimationFrame(e)}if(window.currentVolume=0,window.context=new AudioContext||new webkitAudioContext,!window.context)return void console.log("No support for WebAudio");var a=context.createMediaElementSource(document.getElementById("player")),t=context.createAnalyser();t.smoothingTimeConstant=.9,t.fftSize=512,a.connect(t),t.connect(context.destination),window.currentVolume=0,window.averaging=.97,window.analyser=t,e()}function initVisualization(){function e(e){for(var a=[],t=1;t<=e.LAYERS.max;t+=1)a.push({rotX:t*e.ROTATION.value*(t%2===0?1:-1),rotY:t*e.ROTATION.value*(t%2===0?1:-1),rotZ:t*e.ROTATION.value*(t%2===0?1:-1),n:e.N.value,radius:e.RADIUS.value/Math.pow(t,e.RADIUS_POWER.value),radiusVariability:e.RADIUS_VARIABILITY.value/t,radiusVariabilityPower:e.RADIUS_VARIABILITY_POWER.value});return a}function a(){S=e(P),t()}function t(){p&&p.remove(I),I=s(),p.add(I)}function n(){f?(A.animate({opacity:0},150),setTimeout(function(){A.css({display:"none"})},150)):A.css({opacity:0,display:"block"}).animate({opacity:1},150)}function i(){R=!R;var e=$("#canvas").height(),a=$(window).height();R?($(".show-on-mouse-over-scene").animate({opacity:0},1e3),$(".hide-on-fullscreen").animate({opacity:0},250),w=$("#scene").css("margin-top"),$("#scene").animate({"margin-top":(a-e)/2})):($(".hide-on-fullscreen").animate({opacity:1},250),$("#scene").animate({"margin-top":w}))}function r(){A=$("#controls"),A.click(function(e){e.stopPropagation()}),$("#scene").mouseover(function(e){R||$(".show-on-mouse-over-scene").animate({opacity:.3},2e3)}),$("#scene").mouseleave(function(e){R||$(".show-on-mouse-over-scene").animate({opacity:0},250)}),$("#scene").click(function(e){e.altKey?n():i()}),_.keys(P).map(function(e){var t=P[e];console.log(e,t);var n=$("<label>"),i=$("<input>").attr(t).attr("type","range").on("change",function(t){var n=parseFloat(t.target.value);console.log(e+" = "+n),P[e].value=n,a()});n.append($("<div>").text(e)),n.append(i),A.append(n)})}function o(){l=$("#scene").width(),m=$("#scene").height(),d=new THREE.WebGLRenderer({alpha:!0,canvas:document.getElementById("canvas"),antialias:!1}),d.setSize(l,m),d.setPixelRatio(window.devicePixelRatio?window.devicePixelRatio:1),p=new THREE.Scene,v=new THREE.PerspectiveCamera(50,l/m,20,1e4),v.position.set(0,0,600),p.add(v),a(),requestAnimationFrame(u),window.addEventListener("resize",c)}function c(){l=$("#scene").width(),m=$("#scene").height(),v.aspect=l/m,v.updateProjectionMatrix(),d.setSize(l,m)}function s(){function e(e){var a=e.material,t=e.radius,n=e.rotX,i=e.rotY,r=e.rotZ,o=new THREE.EllipseCurve(0,0,t,t,0,2*Math.PI,(!1),0),c=new THREE.Path(o.getPoints(20)),s=c.createPointsGeometry(20);_.forEach(s.vertices,function(e){e.xOriginal=e.x,e.yOriginal=e.y,e.zOriginal=e.z});var u=new THREE.Line(s,a);return u.rotation.x=n,u.rotation.y=i,u.rotation.z=r,u}function a(a){for(var t=a.material,n=(a.n,a.radius),i=a.radiusVariability,r=a.radiusVariabilityPower,o=new THREE.Object3D,c=0;c<P.N.value;++c){var s=2*(Math.random()-.5)*Math.PI,u=2*(Math.random()-.5)*Math.PI,l=2*(Math.random()-.5)*Math.PI,m=n+Math.pow(n*i*Math.random(),r)*(Math.random()>.5?1:-1);o.add(e({material:t,radius:m,rotX:s,rotY:u,rotZ:l}))}return o}T=new THREE.MeshBasicMaterial({color:"white",fog:!0,opacity:P.OPACITY.value,transparent:!0,depthWrite:!1}),T.baseOpacity=P.OPACITY.value;var t=P.OPACITY.value*(1+P.OPACITY_PULSE_DEPTH.value+Math.random()*P.OPACITY_VARIABILITY.value);E=TweenMax.to(T,P.OPACITY_PULSE_PERIOD.value,{baseOpacity:t,repeat:-1,yoyo:!0,ease:Power2.easeIn}),I=new THREE.Object3D,h=[];for(var n=0;n<P.LAYERS.value;++n){var i=S[n],r=a(Object.assign({material:T},i)),o=P.PULSE_PERIOD.value*(1+Math.random()*P.PULSE_VARIABILITY.value),c=P.PULSE_DEPTH.value*(1+Math.random()*P.PULSE_VARIABILITY.value);r.scaleFactor=0,h.push(TweenMax.to(r,o,{scaleFactor:c,repeat:-1,yoyo:!0,ease:Power3.easeIn})),I.add(r)}return I}function u(){requestAnimationFrame(u);var e=window.currentVolume||0,a=.01;e<a&&!y?(y=!0,E&&(console.log("restart"),E.play()),h&&_.forEach(h,function(e){return e.play()})):e>a&&y&&(console.log("pause"),y=!1,E&&E.pause(),h&&_.forEach(h,function(e){return e.pause()})),_.forEach(I.children,function(a,t){var n=S[t];a.rotation.x+=n.rotX,a.rotation.y+=n.rotY,a.rotation.z+=n.rotZ,a.scale.set(1*(1+a.scaleFactor+P.AUDIO_SENSITIVITY.value*e),1*(1+a.scaleFactor+P.AUDIO_SENSITIVITY.value*e),1*(1+a.scaleFactor+P.AUDIO_SENSITIVITY.value*e)),T.opacity=T.baseOpacity*(.8+8*P.AUDIO_SENSITIVITY.value*e)}),d.render(p,v)}var l,m,d,p,v,I,T,A,E,h,w,y=!0,R=!1,f=!1,P={AUDIO_SENSITIVITY:{min:0,max:1,step:.001,value:.1},AUDIO_AVERAGING:{min:0,max:1,step:1e-4,value:.97},LAYERS:{min:1,max:10,step:1,value:3},N:{min:10,max:1500,step:10,value:230},RADIUS:{min:10,max:500,step:10,value:210},RADIUS_POWER:{min:.1,max:3,step:.01,value:.49},RADIUS_VARIABILITY:{min:0,max:2,step:.005,value:.08},RADIUS_VARIABILITY_POWER:{min:.2,max:4,step:.005,value:.805},OPACITY:{min:.01,max:.5,step:.001,value:.184},OPACITY_VARIABILITY:{min:0,max:2,step:.01,value:.2},OPACITY_PULSE_PERIOD:{min:.1,max:10,step:.01,value:.91},OPACITY_PULSE_DEPTH:{min:0,max:1,step:.01,value:.43},PULSE_DEPTH:{min:0,max:1,step:.001,value:.015},PULSE_PERIOD:{min:0,max:20,step:.01,value:.96},PULSE_VARIABILITY:{min:0,max:2,step:.01,value:0},ROTATION:{min:0,max:.005,step:5e-5,value:.0015},JITTER_PROBABILITY:{min:0,max:1,step:.01,value:0},JITTER_INTENSITY:{min:0,max:1,step:.01,value:0}},S=e(P);o(),r()}var TRACKLISTS=[{name:"Recent Work",tracks:[{id:"everlasting-lights",name:"Everlasting Lights",src:"/music/everlasting-lights.mp3"},{id:"dark-matter",name:"Dark Matter",src:"/music/dark-matter.mp3"},{id:"space-dance",name:"Space Dance",src:"/music/space-dance.mp3"}]},{name:"Solar Wind",tracks:[{id:"mondreise",name:"Mondreise",src:"/music/mondreise.mp3"},{id:"beyond-return",name:"Beyond Return",src:"/music/beyond-return.mp3"},{id:"stardive",name:"Stardive",src:"/music/stardive.mp3"},{id:"lunar-fields",name:"Lunar Fields",src:"/music/lunar-fields.mp3"},{id:"three-sided-truth",name:"Three-Sided Truth",src:"/music/three-sided-truth.mp3"}]},{name:"Jams / Others",tracks:[{id:"jam-in-d",name:"Spacerock Jam in D",src:"/music/jam-in-d.mp3"},{id:"funkturm-insomnia-jam",name:"Funkturm Insomnia Jam",src:"/music/funkturm-insomnia-jam.flac"}]},{name:"Covers",tracks:[{id:"radioactive-toy",name:"Porcupine Tree - Radioactive Toy",src:"/music/radioactive-toy.mp3"}]}],DEFAULT_TRACK=TRACKLISTS[0].tracks[0],currentTrack=null;$(document).ready(function(){buildTracklists(TRACKLISTS),selectTrack(DEFAULT_TRACK),initAudioAnalyser(),initVisualization()});